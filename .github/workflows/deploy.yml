name: Safely CI/CD

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write   # OIDC 사용 시 필수적인 구문임.
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- [CI 구간] ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test
        # 테스트 실패 시 배포 중단을 원하면 -x test 제거.
        # 현재 Redis가 없어서 테스트 실패 가능성이 있으므로 일단 스킵(-x test) 권장.

      # --- [CD 구간] ---
      - name: Generate deployment package
        run: |
          zip -r deploy.zip . -x "*.git*" "build/libs/*-plain.jar"
          # 필요한 파일들만 압축 (JAR 파일이 포함되도록 build 폴더 포함 확인 필요, 
          # 보통 Docker 배포는 소스코드 + Dockerfile만 넘기면 EB가 알아서 빌드하거나,
          # 위처럼 JAR를 미리 만들었다면 Dockerfile COPY 경로에 주의해야 함.)

      - name: Check jar exists # jar 파일 제대로 생성되었는지 테스트 하는 구문임
        run: ls -al build/libs

      - name: Check deploy.zip content # deploy.zip 파일 제대로 생성되었는지 테스트 하는 구문임
        run: unzip -l deploy.zip | head -n 50

        # [중요 수정] AWS EB Docker 플랫폼은 기본적으로
        # 1. Dockerfile이 있으면 -> Docker build 수행
        # 2. docker-compose.yml이 있으면 -> Compose 수행
        # 여기서는 "소스 코드 + Dockerfile"을 넘겨서 EB가 "docker build"를 하게 만드는 방식입니다.
        # 따라서 ./gradlew build로 생긴 jar 파일도 zip에 포함되어야 Dockerfile의 COPY 명령어가 작동합니다.

      # GitHub Action에서 Access Key 없이 바로 AWS로 OIDC 임시토큰 발급받아서 접속함.
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::136022486037:role/github-actions-oidc-eb-deploy
          aws-region: ap-northeast-2

      - name: Install AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install awscli

      - name: Deploy to Elastic Beanstalk (AWS CLI)
        env:
          APP_NAME: safely-app
          ENV_NAME: Safely-app-env
          REGION: ap-northeast-2
          VERSION_LABEL: ver-${{ github.sha }}
          EB_BUCKET: elasticbeanstalk-ap-northeast-2-136022486037
        run: |          
          aws s3 cp deploy.zip s3://$EB_BUCKET/$APP_NAME/$VERSION_LABEL.zip --region $REGION
          
          aws elasticbeanstalk create-application-version \
            --application-name "$APP_NAME" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket=$EB_BUCKET,S3Key=$APP_NAME/$VERSION_LABEL.zip \
            --region $REGION
          
          aws elasticbeanstalk update-environment \
            --environment-name "$ENV_NAME" \
            --version-label "$VERSION_LABEL" \
            --region $REGION