name: Safely CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- [CI 구간] ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # application-prod.yml 같은 파일이 git에 없다면 여기서 생성해주는 단계가 필요할 수 있음
      # 하지만 위에서 변수 처리(${...}) 했으므로 파일만 있으면 됨.

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test
        # 테스트 실패 시 배포 중단을 원하면 -x test 제거.
        # 현재 Redis가 없어서 테스트 실패 가능성이 있으므로 일단 스킵(-x test) 권장.

      # --- [CD 구간] ---
      - name: Generate deployment package
        run: |
          zip -r deploy.zip . -x "*.git*" "build/libs/*-plain.jar"
          # 필요한 파일들만 압축 (JAR 파일이 포함되도록 build 폴더 포함 확인 필요, 
          # 보통 Docker 배포는 소스코드 + Dockerfile만 넘기면 EB가 알아서 빌드하거나,
          # 위처럼 JAR를 미리 만들었다면 Dockerfile COPY 경로에 주의해야 함.)

        # [중요 수정] AWS EB Docker 플랫폼은 기본적으로
        # 1. Dockerfile이 있으면 -> Docker build 수행
        # 2. docker-compose.yml이 있으면 -> Compose 수행
        # 여기서는 "소스 코드 + Dockerfile"을 넘겨서 EB가 "docker build"를 하게 만드는 방식입니다.
        # 따라서 ./gradlew build로 생긴 jar 파일도 zip에 포함되어야 Dockerfile의 COPY 명령어가 작동합니다.

      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: safely-app          # AWS EB 앱 이름
          environment_name: Safely-app-env-1       # AWS EB 환경 이름
          version_label: "ver-${{ github.sha }}"
          region: ${{ secrets.AWS_REGION }}
          deployment_package: deploy.zip