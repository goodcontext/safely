name: Safely CI/CD

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write   # OIDC 사용 시 필수적인 구문임.
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- [CI 구간] ---
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test
        # 테스트 실패 시 배포 중단을 원하면 -x test 제거.

      # --- [CD 구간] ---
      - name: Generate deployment package
        run: |
          zip -r deploy.zip . -x "*.git*" "build/libs/*-plain.jar"
          # 필요한 파일들만 압축 (JAR 파일이 포함되도록 build 폴더 포함 확인 필요, 
          # 보통 Docker 배포는 소스코드 + Dockerfile만 넘기면 EB가 알아서 빌드하거나,
          # 위처럼 JAR를 미리 만들었다면 Dockerfile COPY 경로에 주의해야 함.)

      - name: Check jar exists # jar 파일 제대로 생성되었는지 테스트 하는 구문임
        run: ls -al build/libs

      - name: Check deploy.zip content # deploy.zip 파일 제대로 생성되었는지 테스트 하는 구문임
        run: unzip -l deploy.zip | head -n 50

      # GitHub Action에서 Access Key 없이 바로 AWS로 OIDC 임시토큰 발급받아서 접속함.
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::136022486037:role/github-actions-oidc-eb-deploy
          aws-region: ap-northeast-2

      - name: Install AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install awscli

      - name: Deploy to Elastic Beanstalk (AWS CLI)
        env:
          APP_NAME: safely-app
          ENV_NAME: Safely-app-env
          REGION: ap-northeast-2
          # 깃허브 액션에서 rerun 눌렀을 때도 버전레이블 중복 없이 배포 성공할 수 있도록 github.run_number, github.run_attempt 추가
          VERSION_LABEL: ver-${{ github.sha }}-${{ github.run_number }}-${{ github.run_attempt }}
          EB_BUCKET: elasticbeanstalk-ap-northeast-2-136022486037
        run: |          
          aws s3 cp deploy.zip s3://$EB_BUCKET/$APP_NAME/$VERSION_LABEL.zip --region $REGION
          
          aws elasticbeanstalk create-application-version \
            --application-name "$APP_NAME" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket=$EB_BUCKET,S3Key=$APP_NAME/$VERSION_LABEL.zip \
            --region $REGION
          
          aws elasticbeanstalk update-environment \
            --environment-name "$ENV_NAME" \
            --version-label "$VERSION_LABEL" \
            --region $REGION